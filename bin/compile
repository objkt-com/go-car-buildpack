#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -eo pipefail

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
BP_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)

function topic() {
  echo "-----> $*"
}

if [[ -f "$ENV_DIR/GO_CAR_VERSION" ]]; then
  GO_CAR_VERSION=$(cat "$ENV_DIR/GO_CAR_VERSION")
else
  GO_CAR_VERSION="2.14.2"
fi

GO_CAR_URL="https://github.com/ipld/go-car/releases/download/v${GO_CAR_VERSION}/go-car_${GO_CAR_VERSION}_linux_amd64.tar.gz"

mkdir -p "$BUILD_DIR/.car"

topic "Downloading car tar"
curl -L $GO_CAR_URL -o "$BUILD_DIR/.car/go-car.tar.xz"

topic "Unpacking tar"
tar -xf "$BUILD_DIR/.car/go-car.tar.xz" -C "$BUILD_DIR/.car"

topic "Setting permissions"
chmod +x "$BUILD_DIR/.car/car"

topic "Writing profile script"
mkdir -p "$BUILD_DIR/.profile.d"
RUNTIME_PROFILE_SCRIPT="$BUILD_DIR/.profile.d/go-car.sh"
cat <<EOF >"$RUNTIME_PROFILE_SCRIPT"
export PATH="\$HOME/.car/car:\$PATH"
EOF

export PATH="$BUILD_DIR/.car/car:$PATH"

topic "Exporting environment"
BUILDPACK_EXPORT_FILE="$BP_DIR/export"
export | grep -E -e ' (PATH)=' > "$BUILDPACK_EXPORT_FILE"
