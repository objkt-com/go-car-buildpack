#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -eo pipefail

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)

function topic() {
  echo "-----> $*"
}

if [[ -f "$ENV_DIR/GO_CAR_VERSION" ]]; then
  GO_CAR_VERSION=$(cat "$ENV_DIR/GO_CAR_VERSION")
else
  GO_CAR_VERSION="2.14.2"
fi

GO_CAR_URL="https://github.com/ipld/go-car/releases/download/v${GO_CAR_VERSION}/go-car_${GO_CAR_VERSION}_linux_amd64.tar.gz"

mkdir -p "$CACHE_DIR/.car"

topic "Downloading car tar"
curl -L $GO_CAR_URL -o "$CACHE_DIR/.car/go-car.tar.gz"

topic "Unpacking tar"
tar -xf "$CACHE_DIR/.car/go-car.tar.gz" -C "$CACHE_DIR/.car"

topic "Setting permissions"
chmod +x "$CACHE_DIR/.car/car"

# Create directory in build dir and copy the binary
topic "Moving binary to build directory"
# Create both .car directory and bin directory (for compatibility)
mkdir -p "$BUILD_DIR/.car"
mkdir -p "$BUILD_DIR/bin"
cp "$CACHE_DIR/.car/car" "$BUILD_DIR/.car/"
# Also copy to bin directory for PATH compatibility
cp "$CACHE_DIR/.car/car" "$BUILD_DIR/bin/"
chmod +x "$BUILD_DIR/.car/car"
chmod +x "$BUILD_DIR/bin/car"

topic "Writing profile script"
mkdir -p "$BUILD_DIR/.profile.d"
RUNTIME_PROFILE_SCRIPT="$BUILD_DIR/.profile.d/go-car.sh"
cat <<EOF >"$RUNTIME_PROFILE_SCRIPT"
# Add both locations to PATH for better compatibility
export PATH="\$HOME/.car:\$HOME/bin:\$PATH"
EOF

# Update the current PATH to include both binary locations
export PATH="$BUILD_DIR/.car:$BUILD_DIR/bin:$PATH"

topic "Exporting environment"
BUILDPACK_EXPORT_FILE="$BP_DIR/export"
export | grep -E -e ' (PATH)=' > "$BUILDPACK_EXPORT_FILE"
